<!DOCTYPE html>
<html>
<head>
    <title>Git Stash Navigator</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }
        #container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        #leftPanel {
            width: 300px;
            overflow-y: auto;
            border-right: 1px solid #ccc;
            padding-right: 10px;
        }
        #rightPanel {
            flex-grow: 1;
            padding-left: 10px;
            overflow-y: auto;
        }
        #stashList, #patchList {
            list-style-type: none;
            padding: 0;
        }
        #stashList li, #patchList li {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        button {
            margin-left: 10px;
        }
        #currentRepository {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .patchInfo {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Git Stash Navigator</h1>
    <button id="openRepositoryButton">Open Repository</button>
    <div id="currentRepository"></div>
    <button id="refreshButton" disabled>Refresh Stashes</button>
    <div id="container">
        <div id="leftPanel">
            <h2>Stashes</h2>
            <ul id="stashList"></ul>
            <h2>Saved Patches</h2>
            <ul id="patchList"></ul>
        </div>
        <div id="rightPanel">
            <h2 id="contentTitle"></h2>
            <div id="diffContent"></div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        const openRepositoryButton = document.getElementById('openRepositoryButton');
        const currentRepositoryElement = document.getElementById('currentRepository');
        const stashList = document.getElementById('stashList');
        const patchList = document.getElementById('patchList');
        const refreshButton = document.getElementById('refreshButton');
        const contentTitle = document.getElementById('contentTitle');
        const diffContent = document.getElementById('diffContent');

        let currentRepository = null;

        openRepositoryButton.onclick = async () => {
            try {
                const result = await ipcRenderer.invoke('open-repository');
                if (result.success) {
                    currentRepository = result.path;
                    currentRepositoryElement.textContent = `Current Repository: ${currentRepository}`;
                    refreshButton.disabled = false;
                    await refreshStashes();
                    await refreshSavedPatches();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                console.error('Error opening repository:', error);
                alert('Error opening repository');
            }
        };

        async function refreshStashes() {
            try {
                const stashes = await ipcRenderer.invoke('get-stashes');
                stashList.innerHTML = '';
                stashes.forEach(stash => {
                    const li = document.createElement('li');
                    li.textContent = `${stash.index}: ${stash.description}`;
                    const viewButton = document.createElement('button');
                    viewButton.textContent = 'View';
                    viewButton.onclick = () => viewStashContent(stash.index, stash.description);
                    const applyButton = document.createElement('button');
                    applyButton.textContent = 'Apply';
                    applyButton.onclick = () => applyStash(stash.index);
                    const exportButton = document.createElement('button');
                    exportButton.textContent = 'Export Patch';
                    exportButton.onclick = () => exportStashPatch(stash.index, stash.description);
                    li.appendChild(viewButton);
                    li.appendChild(applyButton);
                    li.appendChild(exportButton);
                    stashList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching stashes:', error);
                alert('Error fetching stashes');
            }
        }

        async function refreshSavedPatches() {
            try {
                const patches = await ipcRenderer.invoke('get-saved-patches');
                patchList.innerHTML = '';
                patches.forEach(patch => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${patch.description}</strong><br>
                        <span class="patchInfo">Stash Index: ${patch.stashIndex}, Created: ${new Date(patch.createdAt).toLocaleString()}</span>
                    `;
                    const viewButton = document.createElement('button');
                    viewButton.textContent = 'View';
                    viewButton.onclick = () => viewPatchContent(patch.fileName);
                    li.appendChild(viewButton);
                    patchList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching saved patches:', error);
                alert('Error fetching saved patches');
            }
        }

        async function applyStash(index) {
            try {
                const result = await ipcRenderer.invoke('apply-stash', index);
                console.log('Stash applied:', result);
                alert('Stash applied successfully');
                refreshStashes();
            } catch (error) {
                console.error('Error applying stash:', error);
                alert('Error applying stash');
            }
        }

        async function viewStashContent(index, description) {
            try {
                const diffString = await ipcRenderer.invoke('get-stash-content', index);
                contentTitle.textContent = `Stash ${index}: ${description}`;
                
                const diff2htmlUi = new Diff2HtmlUI(diffContent, diffString, {
                    drawFileList: true,
                    fileListToggle: false,
                    fileListStartVisible: true,
                    fileContentToggle: false,
                    matching: 'lines',
                    outputFormat: 'side-by-side',
                    synchronisedScroll: true,
                    highlight: true,
                    renderNothingWhenEmpty: false,
                });
                diff2htmlUi.draw();
                diff2htmlUi.highlightCode();
            } catch (error) {
                console.error('Error fetching stash content:', error);
                alert('Error fetching stash content');
            }
        }

        async function exportStashPatch(index, description) {
            try {
                const result = await ipcRenderer.invoke('export-stash-patch', index, description);
                if (result.success) {
                    alert(`Patch file saved successfully at: ${result.path}`);
                    refreshSavedPatches();
                } else {
                    alert(`Failed to save patch file: ${result.error}`);
                }
            } catch (error) {
                console.error('Error exporting stash patch:', error);
                alert('Error exporting stash patch');
            }
        }

        async function viewPatchContent(fileName) {
            try {
                const result = await ipcRenderer.invoke('read-patch-file', fileName);
                if (result.success) {
                    contentTitle.textContent = `Patch: ${fileName}`;
                    
                    const diff2htmlUi = new Diff2HtmlUI(diffContent, result.content, {
                        drawFileList: true,
                        fileListToggle: false,
                        fileListStartVisible: true,
                        fileContentToggle: false,
                        matching: 'lines',
                        outputFormat: 'side-by-side',
                        synchronisedScroll: true,
                        highlight: true,
                        renderNothingWhenEmpty: false,
                    });
                    diff2htmlUi.draw();
                    diff2htmlUi.highlightCode();
                } else {
                    alert(`Failed to read patch file: ${result.error}`);
                }
            } catch (error) {
                console.error('Error reading patch file:', error);
                alert('Error reading patch file');
            }
        }

        refreshButton.onclick = async () => {
            await refreshStashes();
            await refreshSavedPatches();
        };
    </script>
</body>
</html>